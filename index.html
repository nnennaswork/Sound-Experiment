<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Music Listening Study</title>

<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  .survey { display: none; margin-top: 20px; }
  textarea { width: 100%; height: 80px; }
  input, select { width: 100%; padding: 5px; margin: 5px 0; }

  /* TEST MODE BANNER */
  #testBanner {
    background: #cc0000;
    color: white;
    padding: 16px;
    font-size: 26px;
    font-weight: bold;
    text-align: center;
    border: 3px solid white;
    display: none;
    margin-bottom: 20px;
  }

  /* Remove audio download option */
  audio::-internal-media-controls-download-button { display: none; }
  audio::-webkit-media-controls-enclosure { overflow: hidden; }

  /* Skip button */
  #skipButton {
    margin-top: 15px;
    padding: 10px 16px;
    background: #444;
    color: white;
    border: none;
    font-size: 16px;
    cursor: pointer;
    display: none;
  }
  #skipButton:hover { background: #000; }
</style>

</head>
<body>

<!-- TEST MODE BANNER -->
<div id="testBanner">
  ⚠ TEST MODE — DATA WILL BE RECORDED IN SHEETS ⚠
</div>

<h2>Music Listening Study</h2>
<div id="status"></div>

<audio id="player" controls controlsList="nodownload">
  <source id="audioSource" src="">
</audio>

<button id="skipButton">Skip Song</button>

<!-- SURVEY -->
<div id="survey" class="survey">
  <h3>Survey Questions</h3>
  <form id="surveyForm">

    <label>1. What lyrics do you remember? (Song 1)</label>
    <textarea id="q1" required></textarea>

    <label>Song 2</label>
    <textarea id="q2" required></textarea>

    <label>Song 3</label>
    <textarea id="q3" required></textarea>

    <label>2. How did you listen to the music? (Headphones, EarPods, speakers...)</label>
    <input type="text" id="q4" required>

    <label>3. Did you adjust the volume? If so, when/which song?</label>
    <input type="text" id="q5" required>

    <label>4. Rank the songs by enjoyment:</label>
    <ol>
      <li>Song 1:
        <select id="q6" required>
          <option value="">Rank</option>
          <option value="1">1 (most)</option>
          <option value="2">2</option>
          <option value="3">3 (least)</option>
        </select>
      </li>
      <li>Song 2:
        <select id="q7" required>
          <option value="">Rank</option>
          <option value="1">1 (most)</option>
          <option value="2">2</option>
          <option value="3">3 (least)</option>
        </select>
      </li>
      <li>Song 3:
        <select id="q8" required>
          <option value="">Rank</option>
          <option value="1">1 (most)</option>
          <option value="2">2</option>
          <option value="3">3 (least)</option>
        </select>
      </li>
    </ol>

    <button type="submit">Submit Survey</button>
  </form>
</div>

<script>
// --------------------------------------------------
// TEST MODE
// --------------------------------------------------
const TEST_MODE = true; // set true for test
if (TEST_MODE) document.getElementById("testBanner").style.display = "block";

// --------------------------------------------------
// ENDPOINTS (Apps Script Web App)
// --------------------------------------------------
const GROUP_ENDPOINT = "https://script.google.com/macros/s/AKfycbzcOqQYZW407QAa91t8xFl4vccjsCVAIkq9Qai2TgpSVXv4lDBQa7WgeCS9Hvx0qge6/exec";
const LOG_ENDPOINT = "https://script.google.com/macros/s/AKfycbzcOqQYZW407QAa91t8xFl4vccjsCVAIkq9Qai2TgpSVXv4lDBQa7WgeCS9Hvx0qge6/exec";

// --------------------------------------------------
// SONG ORDERS
// --------------------------------------------------
const songOrders = {
  A: [
    {name:"Song 1 Loud", file:"144,000-1.mp3"},
    {name:"Song 2 Standard", file:"CHAKRa.mp3"},
    {name:"Song 3 Quiet", file:"CHAKRa.mp3"}
  ],
  B: [
    {name:"Song 1 Quiet", file:"sCHAKRa.mp3"},
    {name:"Song 2 Loud", file:"CHAKRa.mp3"},
    {name:"Song 3 Standard", file:"CHAKRa.mp3"}
  ],
  C: [
    {name:"Song 1 Standard", file:"144,000-1.mp3"},
    {name:"Song 2 Quiet", file:"144,000-1.mp3"},
    {name:"Song 3 Loud", file:"144,000-1.mp3"}
  ],
  D: [
    {name:"Song 1 Standard", file:"144,000-1.mp3"},
    {name:"Song 2 Standard", file:"144,000-1.mp3"},
    {name:"Song 3 Standard", file:"144,000-1.mp3"}
  ]
};

// --------------------------------------------------
// VARIABLES
// --------------------------------------------------
let participantID = "P" + Math.floor(Math.random()*1000000);
let participantGroup = "";
let currentSongIndex = 0;
let currentSongList = [];

const player = document.getElementById("player");
const source  = document.getElementById("audioSource");
const statusDiv = document.getElementById("status");
const skipButton = document.getElementById("skipButton");

// --------------------------------------------------
// GET GROUP FROM Apps Script
// --------------------------------------------------
fetch(GROUP_ENDPOINT)
  .then(r => r.json())
  .then(data => {
    participantGroup = data.group;
    currentSongList = songOrders[participantGroup];
    statusDiv.textContent = "Loading first song...";
    loadSong(0);
  })
  .catch(() => {
    statusDiv.textContent = "Error retrieving group. Please refresh.";
  });

// --------------------------------------------------
// LOAD SONG
// --------------------------------------------------
function loadSong(index){
  if(index >= currentSongList.length){ showSurvey(); return; }

  source.src = currentSongList[index].file;
  player.load();
  player.play();

  skipButton.style.display = "inline-block";
  statusDiv.textContent = `Playing ${currentSongList[index].name} (${index+1}/3)`;

  logEvent("play", 0, currentSongList[index].name);
}

// --------------------------------------------------
// SKIP BUTTON
// --------------------------------------------------
skipButton.onclick = () => {
  logEvent("skip", player.currentTime, currentSongList[currentSongIndex].name);
  currentSongIndex++;
  loadSong(currentSongIndex);
};

// --------------------------------------------------
// PLAYER EVENTS
// --------------------------------------------------
player.onpause = ()=> logEvent("pause", player.currentTime, currentSongList[currentSongIndex].name);
player.onseeking = ()=> logEvent("seek", player.currentTime, currentSongList[currentSongIndex].name);
player.onended = ()=> {
  logEvent("complete", player.duration, currentSongList[currentSongIndex].name);
  currentSongIndex++;
  loadSong(currentSongIndex);
};

// --------------------------------------------------
// LOG FUNCTION
// --------------------------------------------------
function logEvent(type, time, song){
  fetch(LOG_ENDPOINT, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({
      type: "event",
      participant: participantID,
      group: participantGroup,
      song: song,
      event: type,
      time: time,
      userAgent: navigator.userAgent,
      testMode: TEST_MODE
    })
  }).catch(err => console.error("Logging failed:", err));
}

// --------------------------------------------------
// SHOW SURVEY
// --------------------------------------------------
function showSurvey(){
  player.pause();
  player.style.display = "none";
  skipButton.style.display = "none";
  document.getElementById("survey").style.display = "block";
  statusDiv.textContent = "Please complete the survey.";
}

// --------------------------------------------------
// SURVEY SUBMISSION
// --------------------------------------------------
document.getElementById("surveyForm").addEventListener("submit", e => {
  e.preventDefault();

  const responses = {
    lyrics1: document.getElementById("q1").value,
    lyrics2: document.getElementById("q2").value,
    lyrics3: document.getElementById("q3").value,
    listeningDevice: document.getElementById("q4").value,
    volumeAdjust: document.getElementById("q5").value,
    rankSong1: document.getElementById("q6").value,
    rankSong2: document.getElementById("q7").value,
    rankSong3: document.getElementById("q8").value
  };

  fetch(LOG_ENDPOINT, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      type: "survey",
      participant: participantID,
      group: participantGroup,
      responses: responses,
      testMode: TEST_MODE
    })
  })
  .then(() => {
    statusDiv.textContent = TEST_MODE 
      ? "Survey submitted (TEST MODE). Data recorded in Google Sheets." 
      : "Survey submitted. Thank you!";
    document.getElementById("survey").style.display = "none";
  })
  .catch(err => {
    statusDiv.textContent = "Error submitting survey. Please try again.";
    console.error("Submit error:", err);
  });
});

</script>

</body>
</html>
