<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Music Listening Study</title>
  <style>
    body { font-family: "Helvetica", "Arial", sans-serif;
  padding: 20px; }
    #testBanner { background: #cc0000; color: white; padding: 16px; font-size: 26px; text-align:center; display: none; margin-bottom: 20px; }
    #skipButton { margin-top:15px; padding:10px 16px; background:#444; color:white; border:none; font-size:16px; cursor:pointer; display:none; }
    .survey { display: none; margin-top: 20px; }
    textarea { width:100%; height:80px; }
    input, select { width:100%; padding:5px; margin:5px 0; }
  </style>
</head>
<body>

  <div id="testBanner">⚠ TEST MODE — DATA WILL NOT BE USED ⚠</div>
  <h2>Music Listening Study</h2>
  <div id="status"></div>

  <audio id="player" controls controlsList="nodownload"><source id="audioSource" src=""></audio>
  <button id="skipButton">Skip Song</button>

  <div id="survey" class="survey">
    <h3>Survey Questions</h3>
    <form id="surveyForm">
      <label>1. What lyrics do you remember? (Song 1)</label><textarea id="q1" required></textarea>
      <label>Song 2</label><textarea id="q2" required></textarea>
      <label>Song 3</label><textarea id="q3" required></textarea>
      <label>2. How did you listen to the music? Headphones, speakers, earpods... Be specific.</label><input id="q4" type="text" required>
      <label>3. Did you adjust the volume? When/which song?</label><input id="q5" type="text" required>
      <label>4. Based on your listening experience, rank the songs by enjoyment.(1 being most, 3 being least):</label>
      <ol>
        <li>Song 1: <select id="q6" required><option value="">Rank</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></li>
        <li>Song 2: <select id="q7" required><option value="">Rank</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></li>
        <li>Song 3: <select id="q8" required><option value="">Rank</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></li>
      </ol>
      <button type="submit">Submit Survey</button>
    </form>
  </div>

  <script>
    const TEST_MODE = false;
    if (TEST_MODE) document.getElementById("testBanner").style.display = "block";

    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyZTS7lDGWiUOycngXSMKvwnY1GqJVSXcactaTYj0mNqgSgS81mK_oiBm7VE1NjhZGI/exec";

    // Random group assignment (client-side)
    const groups = ["A", "B", "C", "D"];
    const participantGroup = groups[Math.floor(Math.random() * groups.length)];

    let participantID = "P" + Math.floor(Math.random() * 1000000);
    let currentSongIndex = 0;

    const songOrders = {
      A: [
        {name:"Song 1", file:"MLS-i85-LOUD.mp3"},
        {name:"Song 2", file:"MLS-LIGHT-mid.mp3"},
        {name:"Song 3", file:"MLS-Signal-Low.mp3"}
      ],
      B: [
        {name:"Song 1", file:"MLS-i85-LOW.mp3"},
        {name:"Song 2", file:"MLS-LIGHT-LOUD.mp3"},
        {name:"Song 3", file:"MLS-Signal-Mid.mp3"}
      ],
      C: [
        {name:"Song 1", file:"MLS-i85-MID.mp3"},
        {name:"Song 2", file:"MLS-LIGHT-LOW.mp3"},
        {name:"Song 3", file:"MLS-Signal-Loud.mp3"}
      ],
      D: [
        {name:"Song 1", file:"MLS-i85-MID.mp3"},
        {name:"Song 2", file:"MLS-LIGHT-mid.mp3"},
        {name:"Song 3", file:"MLS-Signal-Mid.mp3"}
      ]
    };

    const currentSongList = songOrders[participantGroup];
    const player = document.getElementById("player");
    const source = document.getElementById("audioSource");
    const statusDiv = document.getElementById("status");
    const skipButton = document.getElementById("skipButton");

    function loadSong(index) {
      if (index >= currentSongList.length) {
        showSurvey();
        return;
      }
      currentSongIndex = index;
      const song = currentSongList[index];
      source.src = song.file;
      player.load();
      player.play().catch(() => {});
      skipButton.style.display = "inline-block";
      statusDiv.textContent = "(Zoom in to see player if mobile) Playing " + song.name;
      logEvent("play", 0, song.name);
    }

    skipButton.onclick = () => {
      logEvent("skip", player.currentTime, currentSongList[currentSongIndex].name);
      loadSong(currentSongIndex + 1);
    };

    player.onpause = () => {
      logEvent("pause", player.currentTime, currentSongList[currentSongIndex].name);
    };

    player.onseeking = () => {
      logEvent("seek", player.currentTime, currentSongList[currentSongIndex].name);
    };

    player.onended = () => {
      logEvent("complete", player.duration, currentSongList[currentSongIndex].name);
      loadSong(currentSongIndex + 1);
    };

    function logEvent(type, time, song) {
      fetch(WEB_APP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          type: "event",
          participant: participantID,
          group: participantGroup,
          song: song,
          event: type,
          time: time,
          userAgent: navigator.userAgent,
          testMode: TEST_MODE
        })
      });
    }

    function showSurvey() {
      player.pause();
      player.style.display = "none";
      skipButton.style.display = "none";
      document.getElementById("survey").style.display = "block";
      statusDiv.textContent = "Please complete the survey.";
    }

    document.getElementById("surveyForm").addEventListener("submit", e => {
      e.preventDefault();
      const responses = {
        lyrics1: document.getElementById("q1").value,
        lyrics2: document.getElementById("q2").value,
        lyrics3: document.getElementById("q3").value,
        listeningDevice: document.getElementById("q4").value,
        volumeAdjust: document.getElementById("q5").value,
        rankSong1: document.getElementById("q6").value,
        rankSong2: document.getElementById("q7").value,
        rankSong3: document.getElementById("q8").value
      };
      fetch(WEB_APP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          type: "survey",
          participant: participantID,
          group: participantGroup,
          responses: responses,
          testMode: TEST_MODE
        })
      });
      statusDiv.textContent = "Survey submitted — thank you!";
      document.getElementById("survey").style.display = "none";
    });

    // Start the first song when the page loads
    loadSong(0);
  </script>
</body>
</html>

